"""
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

üìÅ AdhanKivy/
‚îÇ
‚îú‚îÄ‚îÄ ‚è∞ main.py
‚îÇ   ‚îî‚îÄ‚îÄ üèõÔ∏è MainWindowApp (–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
‚îÇ       ‚îú‚îÄ‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫–Ω–∞
‚îÇ       ‚îÇ   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —à—Ä–∏—Ñ—Ç–æ–≤
‚îÇ       ‚îÇ   - –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ layout
‚îÇ       ‚îÇ   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å —á–∞—Å–∞–º–∏
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ –ú–µ—Ç–æ–¥—ã –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
‚îÇ       ‚îÇ   - get_current_orientation()
‚îÇ       ‚îÇ   - on_window_resize()
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ –ú–µ—Ç–æ–¥—ã –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏
‚îÇ       ‚îÇ   - calculate_font_size()
‚îÇ       ‚îÇ   - update_title_font_size()
‚îÇ       ‚îÇ   - update_title_height()
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ –ú–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–µ–º
‚îÇ           - get_current_time()
‚îÇ           - update_time_with_colon()
‚îÇ
‚îú‚îÄ‚îÄ üñºÔ∏è ui/
‚îÇ   ‚îú‚îÄ‚îÄ üï∞Ô∏è main_portrait.py - –¢–∞–±–ª–∏—Ü–∞ –º–æ–ª–∏—Ç–≤ –¥–ª—è –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
‚îÇ   ‚îÇ   –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –º–æ–ª–∏—Ç–≤ —Å –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π –ø–æ–¥ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üï∞Ô∏è main_landscape.py - –¢–∞–±–ª–∏—Ü–∞ –º–æ–ª–∏—Ç–≤ –¥–ª—è –ª–∞–Ω–¥—à–∞—Ñ—Ç–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
‚îÇ   ‚îÇ   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π layout –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üï∞Ô∏è main_square.py - –¢–∞–±–ª–∏—Ü–∞ –º–æ–ª–∏—Ç–≤ –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
‚îÇ   ‚îÇ   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π layout –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üï∞Ô∏è clock_widget.py - –í–∏–¥–∂–µ—Ç —á–∞—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ üï∞Ô∏è clock_functions.py - –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ üîß settings_manager.py - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ üñ•Ô∏è settings_window.py - –û–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫
‚îÇ
‚îú‚îÄ‚îÄ üìÅ data/
‚îÇ   ‚îî‚îÄ‚îÄ üìä database.py
‚îÇ
‚îî‚îÄ‚îÄ üìÅ logic/
    ‚îî‚îÄ‚îÄ ‚è∞ time_handler.py

"""

# main.py
import kivy
from datetime import datetime
import math
kivy.require('2.2.1')

# –ò–º–ø–æ—Ä—Ç—ã –±–∞–∑–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤ Kivy
from kivy.app import App
from kivy.core.window import Window
from kivy.uix.gridlayout import GridLayout
from kivy.uix.label import Label
from kivy.input.motionevent import MotionEvent
from kivy.clock import Clock
from kivy.core.text import LabelBase
from kivy.metrics import sp
from kivy.uix.anchorlayout import AnchorLayout

# –ò–º–ø–æ—Ä—Ç—ã –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
from ui.settings_window import SettingsWindow
from ui.settings_manager import SettingsManager
from ui.clock_widget import ClockWidget
from data.database import SettingsDatabase
from logic.time_handler import TimeHandler
from ui.main_portrait import create_portrait_prayer_times_table
from ui.main_landscape import create_landscape_prayer_times_table
from ui.main_square import create_square_prayer_times_table

class MainWindowApp(App):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.current_window = 'main'
        self.touch_start_x = None
        self.touch_start_y = None
        self.SWIPE_THRESHOLD = 200  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–≤–∞–π–ø–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        
    def build(self):
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —à—Ä–∏—Ñ—Ç–æ–≤
        LabelBase.register(
            name='PrayerNameFont', 
            fn_regular='fonts/SourceCodePro/SourceCodePro-ExtraLight.ttf'
        )
        LabelBase.register(
            name='PrayerTimeFont', 
            fn_regular='fonts/DSEG-Classic/DSEG14Classic-Regular.ttf'
        )

        # –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω
        Window.clearcolor = (0, 0, 0, 1)
        
        # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è
        Window.bind(on_touch_down=self.on_window_touch_down_double_tap)
        
        # –û—Å–Ω–æ–≤–Ω–æ–π layout - GridLayout
        self.layout = GridLayout(
            cols=1,  # –û–¥–∏–Ω —Å—Ç–æ–ª–±–µ—Ü
            spacing=Window.height * 0.01,  # –£–≤–µ–ª–∏—á–∏—Ç—å –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –≤–∏–¥–∂–µ—Ç–∞–º–∏
            padding=0
        )
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        self.title_label = Label(
            text=self.get_current_time(), 
            font_name="fonts/DSEG-Classic/DSEG7Classic-Bold.ttf",
            color=(0, 1, 0, 1),  # –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç –∫–∞–∫ —É —á–∞—Å–æ–≤
            size_hint_x=1,  # –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É
            size_hint_y=None,  # –æ—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≤—ã—Å–æ—Ç—É
            height=str(Window.width * 0.3) + 'dp',  # –≤—ã—Å–æ—Ç–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —à–∏—Ä–∏–Ω—ã
            pos_hint={'top': 1},  # –ø—Ä–∏–∂–∞—Ç –∫ –≤–µ—Ä—Ö—É
            font_size=str(Window.width // 3.5) + 'sp',  # –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞
            halign='center'  # —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        )
        
        # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞ –∏ –≤—ã—Å–æ—Ç—ã –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        Window.bind(width=self.update_title_font_size)
        Window.bind(height=self.update_title_height)
        Window.bind(on_resize=self.on_window_resize)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –Ω–∞—á–∞–ª–æ –º–∞–∫–µ—Ç–∞
        self.layout.add_widget(self.title_label)

        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã –º–æ–ª–∏—Ç–≤
        current_orientation = self.get_current_orientation()
        
        if current_orientation == 'portrait':
            prayer_times_table = create_portrait_prayer_times_table(self)
        elif current_orientation == 'landscape':
            prayer_times_table = create_landscape_prayer_times_table(self)
        else:  # square
            prayer_times_table = create_square_prayer_times_table(self)
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –º–æ–ª–∏—Ç–≤, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ None
        if prayer_times_table:
            self.layout.add_widget(prayer_times_table)

        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–∏–≥–∞–Ω–∏—è —Ç–æ—á–µ–∫ –∫–∞–∂–¥—ã–µ 0.5 —Å–µ–∫—É–Ω–¥—ã
        self.is_colon_visible = True
        Clock.schedule_interval(self.update_time_with_colon, 0.5)

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ
        self.current_window = 'main'
        
        return self.layout

    def get_current_orientation(self):
        """
        –¢–æ—á–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        """
        width, height = Window.size
        
        if width > height * 1.2:
            return 'landscape'
        elif height > width * 1.2:
            return 'portrait'
        else:
            return 'square'

    def on_window_touch_down_double_tap(self, window, touch):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è"""
        if touch.is_double_tap:
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            self.settings_manager = SettingsManager(None, self)
            self.settings_manager.open_settings_window()
        return False

    def update_title_font_size(self, instance, width):
        """–û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —à–∏—Ä–∏–Ω—ã –æ–∫–Ω–∞"""
        self.title_label.font_size = str(width // 3.5) + 'sp'

    def update_title_height(self, instance, height):
        """–û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —à–∏—Ä–∏–Ω—ã –æ–∫–Ω–∞"""
        self.title_label.height = str(Window.width * 0.3) + 'dp'

    def get_current_time(self, show_colon=True):
        """–ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã—Ç—å –¥–≤–æ–µ—Ç–æ—á–∏–µ"""
        return TimeHandler.get_formatted_time(show_colon)
    
    def update_time_with_colon(self, dt):
        """–û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å –º–∏–≥–∞—é—â–∏–º –¥–≤–æ–µ—Ç–æ—á–∏–µ–º"""
        self.is_colon_visible = not self.is_colon_visible
        self.title_label.text = self.get_current_time(self.is_colon_visible)

    def _on_clock_widget_created(self, clock_widget=None):
        """
        –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–∂–µ—Ç —á–∞—Å–æ–≤ –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        """
        # –ï—Å–ª–∏ clock_widget –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –≤–∏–¥–∂–µ—Ç —á–∞—Å–æ–≤
        if clock_widget is None and hasattr(self.clock_widget, 'clock_widget'):
            clock_widget = self.clock_widget.clock_widget
        
        self.settings_manager.clock_label = clock_widget
        self.settings_manager.apply_saved_color()

    def apply_initial_color(self, dt):
        """–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏"""
        initial_color = self.settings_manager.db.get_setting('color')
        if initial_color:
            color_tuple = SettingsWindow.get_color_tuple(initial_color)
            self.update_title_color(color_tuple)
        
    def update_title_color(self, color):
        """–û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞"""
        self.title_label.color = color
        
    def update_color(self, color_name):
        """–û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –ø–æ –∏–º–µ–Ω–∏"""
        color_tuple = SettingsWindow.get_color_tuple(color_name)
        self.update_title_color(color_tuple)

    def calculate_font_size(self, scale_factor=0.1):
        # –õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è —à–∫–∞–ª–∞ –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        base_size = min(Window.width, Window.height)
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        logarithmic_scale = math.log(base_size + 1, 10)  # +1 —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–µ–ª–∏–Ω–µ–π–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
        font_size = logarithmic_scale * base_size * scale_factor
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∂–µ—Å—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã
        return max(min(font_size, base_size * 0.2), 10)

    def on_window_resize(self, instance, width, height):
        """
        –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        """
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ç–∞–±–ª–∏—Ü—É
        for child in self.layout.children[:]:
            if isinstance(child, GridLayout) and child != self.title_label:
                self.layout.remove_widget(child)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—É—é –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é
        current_orientation = self.get_current_orientation()
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
        if current_orientation == 'portrait':
            prayer_times_table = create_portrait_prayer_times_table(self)
        elif current_orientation == 'landscape':
            prayer_times_table = create_landscape_prayer_times_table(self)
        else:  # square
            prayer_times_table = create_square_prayer_times_table(self)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ None
        if prayer_times_table:
            self.layout.add_widget(prayer_times_table)

    def classify_block_orientation(self, block):
        """
        –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –±–ª–æ–∫ –ø–æ –µ–≥–æ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
        
        :param block: Kivy –≤–∏–¥–∂–µ—Ç
        :return: 'portrait', 'landscape', –∏–ª–∏ 'square'
        """
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –±–ª–æ–∫–∞
        width = block.width
        height = block.height
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º –¥–æ–ø—É—Å–∫–æ–º
        tolerance = 0.1  # 10% –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏
        
        if abs(width - height) / max(width, height) <= tolerance:
            return 'square'
        elif width > height * (1 + tolerance):
            return 'landscape'
        elif height > width * (1 + tolerance):
            return 'portrait'
        else:
            return 'square'

    def separate_blocks_by_orientation(self, layout):
        """
        –†–∞–∑–¥–µ–ª—è–µ—Ç –±–ª–æ–∫–∏ layout –ø–æ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
        
        :param layout: Kivy layout
        :return: –°–ª–æ–≤–∞—Ä—å —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –±–ª–æ–∫–∞–º–∏
        """
        orientations = {
            'portrait': [],
            'landscape': [],
            'square': []
        }
        
        for child in layout.children:
            orientation = self.classify_block_orientation(child)
            orientations[orientation].append(child)
        
        return orientations

if __name__ == "__main__":
    MainWindowApp().run()
